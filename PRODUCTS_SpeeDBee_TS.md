# PRODUCTS : SpeeDBee/TS 

## [目次](#目次)

- [はじめに](#はじめに)
- [特徴](#特徴)
    - [時系列なデータ管理](#時系列なデータ管理)
    - [リアルタイムなデータ分析](#リアルタイムなデータ分析)
    - [超高速なデータ取込み](#超高速なデータ取込み)
- [機能](#機能)
    - [データ登録](#データ登録)
    - [データ取得](#データ取得)
    - [リアルタイム分析（ウィンドウ機能）](#リアルタイム分析ウィンドウ機能)
    - [ストレージへのデータ永続化](#ストレージへのデータ永続化)
- [スペック](#スペック)
- [注意事項](#注意事項)
- [ユースケース](#ユースケース)
- [補足](#補足)
    - [最先端の製品強化計画（開発中）](#最先端の製品強化計画（開発中）)

## [はじめに](#はじめに)

本書はSpeeDBee/TS（時系列データベース）の特徴、機能、制限事項、ユースケースについて説明します。<br>
SpeeDBee/TSでは、工場における製造ライン/家電製品/医療機器/計測機器/ネットワーク機器などで発生/管理される様々なデータにタイムスタンプを付与してデータベースを構築し、以下の機能を提供する組込みシステム専用の時系列データベースです。<br>

1. 時系列で管理するデータベース機能

1. データを登録/検索するためのデータ操作機能

1. 取り込んだデータをリアルタイムに統計/FFT処理を行うリアルタイム分析機能

1. ストレージにバックアップ的にデータ保存するデータ永続化機能
<div style="text-align: right;">
※一部開発中の機能もあります
</div>

<!-- 2. 各種センサー/デバイス/機器からのデータを取り込む機能（データコレクター）
2. クラウド/サーバなどの上位システムと連動機能（データコネクター） -->


## [特徴](#特徴)

### [時系列なデータ管理](#時系列なデータ管理)

SpeeDBee/TSは、すべてのデータを時間（タイムスタンプ）とデータ値をメモリ上で管理します。また、ストレージ上にデータベースを永続化することもできます。

![auto](/art/img_sdts_001.PNG)

### [リアルタイムなデータ分析](#リアルタイムなデータ分析)

時間幅（ウィンドウ）単位のリアルタイムなデータ分析機能によって、データを取り込みながら、基本統計/ FFT分析/ユーザ分析ができます。

1. 基本統計 ：  最大値/最小値/総和/2乗和/平均/分散/標準偏差/不偏分散/標準誤差
1. FFT  ：　取り込んだデータに対してリアルタイムにFFTを実行し周波数分析を行います。s

![auto](/art/img_sdts_window2.PNG)

IoTにおけるゲートウェイなどのエッジ側機器でのエッジコンピューティング（データ量削減、リアルタイム分析＆高速デバイス制御など）に有効です。

以下は、工場での波形信号データ/モータ付近に取り付けた振動データ等の周期性のあるデータを取込み①、一定の件数単位の基本統計分析②、FFT分析③を実施したリアルタイムなデータ分析事例です。

![auto](/art/img_sdts_FFT.PNG)

### [超高速なデータ取込み](#超高速なデータ取込み)

#### 秒間数億件のデータ登録<br>

インメモリDBにおいて、データ取り込みで秒間数億件のデータ登録が行えます。 最適なメモリ利用を行い
排他制御を極限まで最適化したことで、超高速なデータ取り込みを実現しています。

複数チャネルの振動センサーなどの高速＆大量に送られてくるビッグデータを取りこぼすことなくメモリ上に保持し、リアルタイムにデータ分析することができます。
また登録への影響を最小限に抑え、ストレージへデータ保存できます。




## [機能](#機能)

### [データ登録](#データ登録)

SpeeDBee/TSでは、カラム(Column)という概念で、登録するデータの系列を管理します。
> （例）センサーAのデータを登録するカラム"colA"、センサーBのデータを登録するカラム"colB"など

カラムには、登録データの登録レートやデータ長によって４つの種別が用意されており、アプリケーション側でデータ系列に応じて適切なカラムを選択する必要があります。

| カラム種別    | データ登録レート | データ長 | 登録性能 | 特徴 |
| :---          | :---             | :---     | :---     | :--- |
| High          | 固定             | 固定長   | Very Good| データの登録レートと１データのサイズを固定することで、高速なデータ登録を可能にしたカラム種別 |
| Middle        | 半固定           | 固定長   | Good     | ある程度定期的に発生するが完全に登録レートが固定できないデータのためのカラム種別。HighとLowの中間 |
| Low-Fixed   | 可変             | 固定長   | So so    | 不定期に発生する固定長のデータを登録するためのカラム種別 |
| Low-Variable  | 可変             | 可変長   | So so    | 不定期に発生する可変長のデータを登録するためのカラム種別 |

データを登録する際には、そのデータ系列用のカラムと、そのデータのタイムスタンプを併せて登録する必要があります。

また、時間軸上に一定間隔で連続するデータについては配列形式で登録することができ、
その場合は先頭データのタイムスタンプのみを指定することで、後続データのタイムスタンプは自動算出されます。


### [データ取得](#データ取得)

#### 最新データの取得

カラム毎に、登録されている最新のデータは高速に取得できます。

#### 区間集約

複数のカラムに対して、時系列上で連続する区間における各カラムのデータを高速に取得できます。
各区間内に同一カラムのデータが複数存在する場合は、最新/最古などの代表値を指定することができます。

![auto](/art/区間集約.png)

### [リアルタイム分析（ウィンドウ機能）](#リアルタイム分析ウィンドウ機能)

時間幅（ウィンドウ）単位のリアルタイム分析機能によって、データを取り込みながら、基本統計（最小、最大、平均、標準偏差など）/ FFT分析/ユーザ分析ができます。<br>
IoTにおけるゲートウェイなどのエッジ側機器でのエッジコンピューティング（データ量削減、リアルタイム分析＆デバイス制御など）に有効です。<br>

#### リアルタイム分析を行うデータの幅（ウィンドウ）

取り込まれるデータをリアルタイム処理するために区切ります。<br>
この区切った間をウィンドウと呼び、各ウィンドウの境界で定義したリアルタイム分析の処理が実行されます。<br>
ウィンドウはカラム単位に定義します。1カラムに複数のウィンドウを定義することも可能です。

![auto](/art/window.PNG)

#### ウィンドウタイプ

ウィンドウは、以下のタイプによって幅を定義できます。

|# | ウィンドウタイプ | 説明 |
|---|---|---|
|1 | カウントウィンドウ | 指定件数単位のウィンドウ |
|2 | FFTウィンドウ | FFT分析のためのウィンドウ |


### [ストレージへのデータ永続化](#ストレージへのデータ永続化)

時系列データベースの運用時に電断などが発生した際のデータ損失を防止するために、ストレージへのデータベース永続化機能を提供します。ゲートウェイなどのデータ収集機器上でのデータバックアップ機能としても利用できます。<br>
永続化機能は、DB作成時に永続化する情報（永続化間隔/単位など）を設定します。
永続化データベースに対しても、SpeeDBee/TSの同一のAPIによって過去データからのデータ検索も可能です。<br>


## [スペック](#スペック)

以下にSpeeDBee/TSのスペックを示します。<br>

| 名称    | スペック   |
| :------------ | :-------------------- |
| フットプリント | 50KB～800KB （実装機能、OS環境などに依存）  |
| 実装形式 | ライブラリ提供 |
| データモデル   | TimeSeries（時系列）型 |
| 最大データベースサイズ | システム依存 |
| 最大カラム数   | 最大2,147,483,647個まで<br>※ただしシステム（メモリ容量）に依存 |
| 最大データ数   | 無制限（システム依存） |
| カラム種別 | High（超高速 : 周期固定）<br> Middle（高速 : 周期変動）<br> Low（低速 : 時間＋データ）<br>　Low-Fixed（固定長データフォーマット）<br>　Low-Variable（可変長データフォーマット）<br>※ High と Middle の上限値はシステム依存。<br>※ Low-Variable の上限値は理論上 Mutex のシステム上限に依存    |
| カラム種別ごとの<br>最大登録データサイズ | High（64 byte）<br> Middle（256 byte）<br> Low-Fixed（65535 Kbyte）<br>Low-Variable（デフォルト 256 byte）※ カラム作成時のパラメータ指定で 65535 byteまで変更可能。    |
| ウィンドウ機能   | カウントウィンドウ、FFT ウィンドウ |
| 　リアルタイム分析   | 基本統計（最大値/最小値/総和/2乗和/平均/分散/標準偏差/不偏分散/標準誤差等）、FFT |
|区間集約の最大カラム数 | 最大1,024個まで |
| サポートOS     | Windows7/8/10、WindowsEmbedded、WindowsCE、Linux、<br>μITRON、eT-Kernel、VxWorks、Non-OS に対応<br>※移植に際しては、HW/SW 環境のご提供と、サポート窓口の開示をお願いします。          |
| データ共有   | マルチスレッド |
| サポートCPU    | 32bit、64bit 各種CPU に対応 |


## [注意事項](#注意事項)

時系列データベースは、データ登録時の排他制御に関しては、以下の２タイプをサポートします。

1. 排他処理をサポート
データの登録速度とトレードオフで、排他処理をサポートします。排他処理は、ビルドオプション
で指定できます。
1. 排他処理をサポートしない
データの登録速度を優先し、API内部の処理負荷を最小化するために、データ登録時には
排他制御をサポートしていません。下記の事を注意して利用する必要があります。

    - IF初期化用のAPIは、プロセスまたはカーネル起動時と終了時に行う。
    - DB作成、DBオープン、カラム作成などDB管理操作は、データ登録・検索が行われる前に実行し、同時に実行しないよう制御する。
    - DB削除、DBカラム削除操作の実行においても削除対象のDB、カラム、ファイルに他のプロセス・スレッドのアクセスがないことをアプリ側で確認、アクセスしないよう制御する。
    - 一意のカラムへのデータ登録は、１タスク（スレッド）で行う。複数のタスク（スレッド）から同一カラムへ登録を行う場合には、アプリケーション側で同期をとり、並列実行しないようにする。



## [ユースケース](#ユースケース)

### CPU使用率の取得

SpeeDBee/TSを利用したサンプルを用意しています。
Linux環境において、「/proc/stat」を参照して1秒ごとのCPU使用率を求めてSpeeDBeeに格納しています。
10秒ごとに、各論理プロセッサの最大使用率、最小使用率、平均使用率を算出しています。
詳細については、[CPU使用率を表示するサンプル](https://github.com/saltyster/testrepo/blob/master/samples/src/SampleCpuMonitoring.c)をご確認ください。

## 補足

### [最先端の製品強化計画（開発中）]()

